name: "Deploy to EKS with Grafana Dashboards"
description: "Deploy app, Prometheus, Grafana, and Chaos Mesh to EKS"

inputs:
  AWS_ACCESS_KEY_ID:
    description: "AWS Access Key ID"
    required: true
  AWS_SECRET_ACCESS_KEY:
    description: "AWS Secret Access Key"
    required: true
  AWS_REGION:
    description: "AWS Region"
    required: true
  AWS_ACCOUNT_ID:
    description: "AWS Account ID"
    required: true

runs:
  using: "composite"
  steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ inputs.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ inputs.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ inputs.AWS_REGION }}

    - name: Set up kubeconfig
      shell: bash
      run: |
        aws eks update-kubeconfig --name ci-cd-cluster --region ${{ inputs.AWS_REGION }}

    - name: Install Helm
      shell: bash
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    - name: Add Helm repos
      shell: bash
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo add chaos-mesh https://charts.chaos-mesh.org
        helm repo update

    - name: Deploy app with Helm
      shell: bash
      run: |
        helm upgrade --install devops ./k8s \
          --namespace default --create-namespace \
          --set awsAccountId=${{ inputs.AWS_ACCOUNT_ID }} \
          --set awsRegion=${{ inputs.AWS_REGION }}

    - name: Deploy Prometheus
      shell: bash
      run: |
        helm upgrade --install prometheus prometheus-community/prometheus \
          --namespace monitoring --create-namespace \
          --set server.persistentVolume.enabled=false

    - name: Deploy Grafana
      shell: bash
      run: |
        helm upgrade --install grafana grafana/grafana \
          --namespace monitoring --create-namespace \
          --set adminPassword='admin' \
          --set service.type=LoadBalancer

    - name: Deploy Chaos Mesh
      shell: bash
      run: |
        helm upgrade --install chaos-mesh chaos-mesh/chaos-mesh \
          --namespace=chaos-testing --create-namespace \
          --set chaosDaemon.runtime=containerd \
          --set chaosDaemon.socketPath=/run/containerd/containerd.sock \
          --set dashboard.create=true

    - name: Wait for Grafana LoadBalancer URL
      id: grafana
      shell: bash
      run: |
        echo "Waiting for Grafana LoadBalancer external URL..."

        for i in {1..30}; do
          url=$(kubectl get svc grafana -n monitoring -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          if [ -z "$url" ]; then
            url=$(kubectl get svc grafana -n monitoring -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          fi

          if [ -n "$url" ] && [ "$url" != "<pending>" ]; then
            GRAFANA_URL="http://$url"
            echo "Grafana URL found: $GRAFANA_URL"
            echo "GRAFANA_URL=$GRAFANA_URL" >> $GITHUB_ENV
            exit 0
          fi

          echo "Still waiting for Grafana LoadBalancer..."
          sleep 10
        done

        echo "ERROR: Grafana LoadBalancer URL not found."
        exit 1

    - name: Create Grafana API Key
      shell: bash
      run: |
        echo "Creating Grafana API key..."

        GRAFANA_PASSWORD="admin"

        payload='{"name":"ci-key","role":"Admin"}'

        response=$(curl -s -X POST "$GRAFANA_URL/api/auth/keys" \
          -H "Content-Type: application/json" \
          -u admin:$GRAFANA_PASSWORD \
          -d "$payload")

        api_key=$(echo "$response" | jq -r '.key')

        if [ "$api_key" = "null" ] || [ -z "$api_key" ]; then
          echo "Error: Failed to generate Grafana API key"
          echo "$response"
          exit 1
        fi

        echo "GRAFANA_API_KEY=$api_key" >> $GITHUB_ENV

    - name: Upload Grafana Dashboards
      if: ${{ inputs.GRAFANA_API_KEY != '' }}
      shell: bash
      run: |
        echo "Uploading dashboards to Grafana at $GRAFANA_URL"

        sudo apt-get update
        sudo apt-get install -y jq

        for dashboard in grafana/dashboards/*.json; do
          name=$(basename "$dashboard" .json)
          echo "Uploading $name dashboard..."

          payload=$(jq -n \
            --slurpfile db "$dashboard" \
            '{ dashboard: $db[0], overwrite: true }'
          )

          status=$(curl -s -o /tmp/resp.txt -w "%{http_code}" \
            -X POST "$GRAFANA_URL/api/dashboards/db" \
            -H "Authorization: Bearer $GRAFANA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$payload"
          )

          if [ "$status" -eq 200 ]; then
            echo "Uploaded $name"
          else
            echo "Failed to upload $name (HTTP $status)"
            cat /tmp/resp.txt
          fi
        done
